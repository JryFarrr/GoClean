// ============================================================================
// PRISMA SCHEMA - GoClean Database (Restored to Original ERD)
// ============================================================================
// Last Modified: 2025-12-26
// Migration: Restored from merged User/Akun to separated structure
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS - Authentication & Users (Sesuai ERD Asli)
// ============================================================================

// AKUN - Tabel Autentikasi (Terpisah)
model Akun {
  id        String   @id @default(cuid()) @map("IDAkun")
  email     String   @unique @map("Email")
  password  String   @map("Password")
  role      String   @map("Role") // "USER", "TPS", "ADMIN"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations: Akun bisa punya User ATAU ProfileTps (tidak keduanya)
  user       User?
  profileTps ProfileTps?
  
  @@map("Akun")
}

// USER - Data Masyarakat
model User {
  id          String     @id @default(cuid()) @map("IDUser")
  idAkun      String     @unique @map("IDAkun") // FK ke Akun
  akun        Akun       @relation(fields: [idAkun], references: [id], onDelete: Cascade)
  nama        String     @map("Nama")
  alamat      String?    @map("Alamat")
  noTelp      String?    @map("NoTelp")
  idKecamatan String?    @map("IDKecamatan")
  kecamatan   Kecamatan? @relation(fields: [idKecamatan], references: [id])
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  transaksi Transaksi[] @relation("UserTransaksi")
  
  @@map("User")
}

// PROFILETPS - Data TPS (TIDAK terkait ke User, tapi ke Akun)
model ProfileTps {
  id             String     @id @default(cuid()) @map("IDTps")
  idAkun         String     @unique @map("IDAkun") // FK ke Akun (bukan User!)
  akun           Akun       @relation(fields: [idAkun], references: [id], onDelete: Cascade)
  namaTps        String     @map("NamaTps")
  alamat         String     @map("Alamat")
  longitude      Float      @map("Longitude")
  latitude       Float      @map("Latitude")
  jamOperasional String?    @map("JamOperasional")
  idKecamatan    String?    @map("IDKecamatan")
  kecamatan      Kecamatan? @relation(fields: [idKecamatan], references: [id])
  foto           String?    @map("Foto")
  noTelp         String?    @map("NoTelp")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  // Relations
  transaksi    Transaksi[] @relation("TpsTransaksi")
  objectPoints ObjekPoint[]
  
  @@map("ProfileTps")
}

// ============================================================================
// TRANSACTION MODELS - Transaksi & Detail Sampah
// ============================================================================

// TRANSAKSI - Permintaan Penjemputan/Drop-off
model Transaksi {
  id               String      @id @default(cuid()) @map("IDTransaksi")
  idUser           String      @map("IDUser")
  user             User        @relation("UserTransaksi", fields: [idUser], references: [id], onDelete: NoAction, onUpdate: NoAction)
  idTps            String?     @map("IDTps")
  tps              ProfileTps? @relation("TpsTransaksi", fields: [idTps], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tanggalTransaksi DateTime    @default(now()) @map("TanggalTransaksi")
  jamTransaksi     String?     @map("JamTransaksi")
  statusTransaksi  String      @default("PENDING") @map("StatusTransaksi") // PENDING, COMPLETED
  alamatJemput     String      @map("AlamatJemput")
  longitude        Float       @map("Longitude")
  latitude         Float       @map("Latitude")
  
  // Optional fields dari PickupRequest lama (keep untuk compatibility)
  type         String?   @map("Type") // PICKUP, DROP_OFF
  scheduledAt  DateTime? @map("ScheduledAt")
  completedAt  DateTime? @map("CompletedAt")
  description  String?   @map("Description")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  detailSampah DetailSampah[]
  
  @@map("Transaksi")
}

// DETAILSAMPAH - Item sampah dalam transaksi
model DetailSampah {
  id            String         @id @default(cuid()) @map("IDDetail")
  idTransaksi   String         @map("IDTransaksi")
  transaksi     Transaksi      @relation(fields: [idTransaksi], references: [id], onDelete: Cascade)
  idKategori    String         @map("IDKategori")
  kategori      KategoriSampah @relation(fields: [idKategori], references: [id])
  berat         Float          @map("Berat")
  
  // Optional fields untuk flexibility
  estimatedWeight Float? @map("EstimatedWeight")
  actualWeight    Float? @map("ActualWeight")
  price           Float? @map("Price")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("DetailSampah")
}

// KATEGORISAMPAH - Jenis-jenis sampah
model KategoriSampah {
  id           String         @id @default(cuid()) @map("IDKategori")
  jenisSampah  String         @unique @map("JenisSampah") // ORGANIC, PLASTIC, PAPER, etc.
  deskripsi    String?        @map("Deskripsi")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  // Relations
  detailSampah DetailSampah[]
  
  @@map("KategoriSampah")
}

// ============================================================================
// GIS LAYERS - Struktur Data GIS (Keep as is)
// ============================================================================

// Kecamatan
model Kecamatan {
  id            String       @id @default(cuid()) @map("IDKecamatan")
  namaKecamatan String       @map("NamaKecamatan")
  kodeKecamatan String?      @map("KodeKecamatan")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  users        User[]
  profileTps   ProfileTps[]
  objekPoints  ObjekPoint[]
  areas        Area[]
  
  @@map("Kecamatan")
}

// Kategori (untuk ObjekPoint, bukan sampah)
model Kategori {
  id           String       @id @default(cuid()) @map("IDKategori")
  namaKategori String       @map("NamaKategori")
  deskripsi    String?      @map("Deskripsi")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  // Relations
  objekPoints ObjekPoint[]
  
  @@map("Kategori")
}

// ObjekPoint - Point layer
model ObjekPoint {
  id          String      @id @default(cuid()) @map("PointID")
  namaObjek   String      @map("NamaObjek")
  kategoriId  String      @map("KategoriID")
  kategori    Kategori    @relation(fields: [kategoriId], references: [id], onDelete: Cascade)
  latitude    Float       @map("Latitude")
  longitude   Float       @map("Longitude")
  deskripsi   String?     @map("Deskripsi")
  kecamatanId String      @map("KecamatanID")
  kecamatan   Kecamatan   @relation(fields: [kecamatanId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  // Link to TPS if this point represents a TPS
  idTps       String?     @map("IDTps")
  profileTps  ProfileTps? @relation(fields: [idTps], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("ObjekPoint")
}

// Jalan - Line layer
model Jalan {
  id            String   @id @default(cuid()) @map("JalanID")
  namaJalan     String   @map("NamaJalan")
  koordinatJSON String   @map("KoordinatJSON") @db.NVarChar(Max)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("Jalan")
}

// Area - Polygon layer
model Area {
  id          String     @id @default(cuid()) @map("AreaID")
  namaArea    String     @map("NamaArea")
  polygonJSON String     @map("PolygonJSON") @db.NVarChar(Max)
  kecamatanId String?    @map("KecamatanID")
  kecamatan   Kecamatan? @relation(fields: [kecamatanId], references: [id], onDelete: SetNull)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@map("Area")
}

// ============================================================================
// NOTE: Removed models (not in original ERD):
// - TPSLocation (redundant with ProfileTps)
// - TPSProfile (renamed to ProfileTps)
// - PickupRequest (renamed to Transaksi)
// - WasteItem (renamed to DetailSampah)
// - WastePrice (not in ERD, removed for simplicity)
// ============================================================================
